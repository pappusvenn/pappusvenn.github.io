<!DOCTYPE html>
<html>
 
<head>
  <meta charset="utf-8">
  <title>Dave's Superior Flight Search</title>
  <link href="https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="main.css"/>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2hkwSclaKkxutpMtFGtsJfEXajcoSmls"></script>
  <!-- Javascript to establish the datepicker -->
  <script>
     $(function() {
        $( "#datepicker-1" ).datepicker();
     });
  </script>
</head>
 
<body>
 <h1>Dave's Superior Flight Search</h1>
 <p>Origin Address (Street, City, State): <input type="text" id="originadd"><span id=ogapts></span></p>
 <p>Destination Address (Street, City, State): <input type="text" id="destadd"><span id=endapts></span></p>
 <p>Enter Date: <input type="text" id="datepicker-1"></p>
 <input type="button" id="compare-flights" value="Search">
 <div id="supercool"></div>
 
  <script>
    document.getElementById('compare-flights').addEventListener('click',function(){
         searchandcompare();
    });
    
function loadjson() {
  var xobj = new XMLHttpRequest();
  xobj.overrideMimeType("application/json");
  xobj.open('GET', 'airports.json', false); 
  var aeroportos = "What the fuck?";
  xobj.onreadystatechange = function () {
  if (xobj.readyState == 4 && xobj.status == "200") {
    aeroportos = xobj.responseText;}
  };
    xobj.send(null);
    return aeroportos;
}

function searchandcompare(){
   var airports = JSON.parse(loadjson());//works because we made loadjson a synchronous request. so this must happen first.
   var origin = document.getElementById('originadd').value;
   var destination = document.getElementById('destadd').value;
   var date = document.getElementById('datepicker-1').value;
   var originairports = [];
   var destinationairports = [];
   var okwecheck = "  Ok, we'll check these airports: ";
   var oaptstring = "";
   var destaptstring = "";
   var geocoder = new google.maps.Geocoder();
   geocoder.geocode( { 'address': origin}, function(results, status) {
   if (status == 'OK') {
        var originlat = results[0].geometry.location.lat();
        var originlng = results[0].geometry.location.lng();
        var j;
        originairports = findairports(originlat,originlng,airports);
        for (j=0; j<originairports.length; j++) {
           oaptstring += originairports[j].code + ", ";
           originairports[j].uberest = ubercost(originlat,originlng,originairports[j].lat,originairports[j].lng);
           console.log(originairports[j].uberest);
        }
        document.getElementById('ogapts').innerHTML = okwecheck + oaptstring;
        //OK now that we have the origin airports, we need to do the same thing for the destination airports.  
        //Need to nest b/c it's asynchronous
        geocoder.geocode( { 'address': destination}, function(results2, status2) {
        if (status2 == 'OK') {
             var destinationlat = results2[0].geometry.location.lat();
             var destinationlng = results2[0].geometry.location.lng();
             var x;
             destinationairports = findairports(destinationlat,destinationlng,airports);
             for (x=0; x<destinationairports.length; x++) {
                destaptstring += destinationairports[x].code + ", ";
                destinationairports[x].uberest = ubercost(destinationlat,destinationlng,destinationairports[x].lat,destinationairports[x].lng);
                console.log(destinationairports[x].uberest);
             }
             document.getElementById('endapts').innerHTML = okwecheck + destaptstring;   
                //Now we do the flight searches
                for (var y = 0; y < originairports.length; y++){
                   for (var z = 0; z < destinationairports.length; z++){
                       console.log(flightsearch(originairports[y].code, destinationairports[z].code, date));
                   }
                }
        } else {
                   alert('Destination search was not successful for the following reason: ' + status2);
               }
        //end of the second (destination) geocoder 
        });     
  } else {
       alert('Origin search was not successful for the following reason: ' + status);
    }
   //end of the first (origin) geocoder
   });

//end of function searchandcompare  
}
  function findairports(num1,num2,list){
     var i;
     var areaports = [];
     for(i=0; i<list.length; i++) {
        if (distance(num1,num2,list[i].lat,list[i].lng) < 100){
           areaports.push(list[i]);
        } 
     }
     return areaports;
  }
  
  function distance(lat1, lon1, lat2, lon2){
    //Haversine formula from http://www.movable-type.co.uk/scripts/latlong.html
    var R = 6371e3; // metres
    var φ1 = lat1*0.0174533;
    var φ2 = lat2*0.0174533;
    var Δφ = (lat2-lat1)*0.0174533;
    var Δλ = (lon2-lon1)*0.0174533;

    var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    var d = R * c;
    var dist = d/1609.34;
    return dist;
  }
    
    function ubercost(startlat,startlng,endlat,endlng){
     var url = 'https://api.uber.com/v1/estimates/price?server_token=K8rh0YGXPtdHEFJepmOT-DsWT6_CcplY69BOhu7F';
      var stla = '&start_latitude=' + startlat.toString();
      var stln = '&start_longitude=' + startlng.toString();
      var enla = '&end_latitude=' + endlat.toString();
      var enln = '&end_longitude=' + endlng.toString();
      url = url + stla + stln + enla + enln;
      var response;
      var uberXavg = 0.0;
      
      var xub = new XMLHttpRequest();
      xub.open('GET', url, false);
      xub.onreadystatechange = function () {
          if (xub.readyState == 4 && xub.status == "200") {
                   response = JSON.parse(xub.responseText);
                   var k;
                   for (k = 0; k < response.prices.length; k++){
                     if (response.prices[k].display_name == "uberX") {
                        uberXavg = (response.prices[k].low_estimate + response.prices[k].high_estimate)/2
                     }
                  } 
                   
          } else {
                   alert("Uber Price Search Failed");
               }
       }
       xub.setRequestHeader("Authorization", "Token K8rh0YGXPtdHEFJepmOT-DsWT6_CcplY69BOhu7F");
       xub.send();
       return(uberXavg);
     }
     
    function flightsearch(ognapt,dstapt,flightday){
     var request = {};
     request.slice = {};
     request.passengers = {};
     request.slice.origin = ognapt;
     request.slice.destination = dstapt;
     request.slice.date = flightday;
     request.passengers.adultCount = 1;
     request.passengers.infantInLapCount = 0;
     request.passengers.infantInSeatCount = 0;
     request.passengers.childCount = 0;
     request.passengers.seniorCount = 0;
     request.solutions = 10;
     request.refundable = false;
     return JSON.stringify(request);
    }
    //'var xhr = new XMLHttpRequest();
    //'var url = "https://www.googleapis.com/qpxExpress/v1/trips/search?key=AIzaSyBDPcpkXlwpVY7G4yr0v_sshszmUKmASP4";
    
    //'xhr.onreadystatechange=function() {
    //'if (this.readyState == 4 && this.status == 200) {
     //   'myFunction(this.responseText);
    //''}
     //''}
    
    // 'xhr.open('POST', url, true);
     //'xhr.setRequestHeader("Content-Type", "application/json");
     //'xhr.send('{"request": {"slice": [{"origin": "DFW","destination": "SFO","date": "2016-09-23"}],"passengers": {"adultCount": 1,"infantInLapCount": 0,"infantInSeatCount": 0,"childCount": 0,"seniorCount": 0},"solutions": 20,"refundable": false}}');
     

    //'function myFunction(response) {
     //var arr = JSON.parse(response);
     //var i;
     //var out = response;

     
      
      
  </script>
  
  
</body>
 
</html>
