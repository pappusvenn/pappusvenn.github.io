<!DOCTYPE html>
<html>
 
<head>
  <meta charset="utf-8">
  <title>TrueCost Flight Search</title>
  <link href="http://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="main.css"/>
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2hkwSclaKkxutpMtFGtsJfEXajcoSmls"></script>
  <!-- Javascript to establish the datepicker -->
  <script>
     $(function() {
        $( "#datepicker-1" ).datepicker();
     });
  </script>
</head>
 
<body>
 <h1> TrueCost Flight Search</h1>
 <p>Origin Address (Street, City, State): <input type="text" id="originadd"><span id=ogapts></span></p>
 <p>Destination Address (Street, City, State): <input type="text" id="destadd"><span id=endapts></span></p>
 <p>Enter Date: <input type="text" id="datepicker-1"></p>
 <input type="button" id="compare-flights" value="Search">
 <div id="supercool"></div>
 
  <script>
    document.getElementById('compare-flights').addEventListener('click',function(){
         searchandcompare();
    });
    
function loadjson() {
  var xobj = new XMLHttpRequest();
  xobj.overrideMimeType("application/json");
  xobj.open('GET', 'airports.json', false); 
  var aeroportos = "What the fuck?";
  xobj.onreadystatechange = function () {
  if (xobj.readyState == 4 && xobj.status == "200") {
    aeroportos = xobj.responseText;}
  };
    xobj.send(null);
    return aeroportos;
}

function searchandcompare(){
   var airports = JSON.parse(loadjson());//works because we made loadjson a synchronous request. so this must happen first.
   var origin = document.getElementById('originadd').value;
   var destination = document.getElementById('destadd').value;
   var originairports = [];
   var destinationairports = [];
   var originubers = [];
   var destinationubers = [];
   var okwecheck = "  Ok, we'll check these airports: ";
   var geocoder = new google.maps.Geocoder();
   geocoder.geocode( { 'address': origin}, function(results, status) {
   if (status == 'OK') {
        var originlat = results[0].geometry.location.lat();
        var originlng = results[0].geometry.location.lng();
        console.log(originlat, originlng);
        originairports = findairports(originlat,originlng,airports);
        //OK now that we have the origin airports, we need to do the same thing for the destination airports.  
        //Need to nest b/c it's asynchronous
        geocoder.geocode( { 'address': destination}, function(results2, status2) {
        if (status2 == 'OK') {
             var destinationlat = results2[0].geometry.location.lat();
             var destinationlng = results2[0].geometry.location.lng();
             destinationairports = findairports(destinationlat,destinationlng,airports);
             console.log(destinationlat, destinationlng);
             document.getElementById('ogapts').innerHTML = okwecheck + originairports[0].code;
             document.getElementById('endapts').innerHTML = okwecheck + destinationairports[0].code;
        } else {
                   alert('Destination search was not successful for the following reason: ' + status2);
               }
        //end of the second (destination) geocoder 
        });     
  } else {
       alert('Origin search was not successful for the following reason: ' + status);
    }
   //end of the first (origin) geocoder
   });

//end of function searchandcompare  
}
  function findairports(num1,num2,list){
     var i;
     var areaports = [];
     for(i=0; i<list.length; i++) {
        if (distance(num1,num2,list[i].lat,list[i].lng) < 100){
           alert('Found Airport' + list[i].code);
           areaports.push(list[i]);
        } 
     }
     return areaports;
  }
  
  function distance(lat1, lon1, lat2, lon2){
    //Haversine formula from http://www.movable-type.co.uk/scripts/latlong.html
    var R = 6371e3; // metres
    var φ1 = lat1*0.0174533;
    var φ2 = lat2*0.0174533;
    var Δφ = (lat2-lat1)*0.0174533;
    var Δλ = (lon2-lon1)*0.0174533;

    var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    var d = R * c;
    var dist = d/1609.34;
    return dist;
  }
    
    //function ubercost(num1,num2,)
    //'var xhr = new XMLHttpRequest();
    //'var url = "https://www.googleapis.com/qpxExpress/v1/trips/search?key=AIzaSyBDPcpkXlwpVY7G4yr0v_sshszmUKmASP4";
    
    //'xhr.onreadystatechange=function() {
    //'if (this.readyState == 4 && this.status == 200) {
     //   'myFunction(this.responseText);
    //''}
     //''}
    
    // 'xhr.open('POST', url, true);
     //'xhr.setRequestHeader("Content-Type", "application/json");
     //'xhr.send('{"request": {"slice": [{"origin": "DFW","destination": "SFO","date": "2016-09-23"}],"passengers": {"adultCount": 1,"infantInLapCount": 0,"infantInSeatCount": 0,"childCount": 0,"seniorCount": 0},"solutions": 20,"refundable": false}}');
     

    //'function myFunction(response) {
     //var arr = JSON.parse(response);
     //var i;
     //var out = response;

     
      
      
  </script>
  
  
</body>
 
</html>
